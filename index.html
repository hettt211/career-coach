<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŒåœºæˆé•¿AIåŠ©æ‰‹ - Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è‡ªå®šä¹‰æ ·å¼ */
        .chat-bubble {
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #6b7280;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        .typing-dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        
        .message-content {
            line-height: 1.6;
        }
        
        .message-content ul {
            margin: 0.5rem 0;
            padding-left: 1.5rem;
        }
        
        .message-content li {
            margin: 0.25rem 0;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="max-w-4xl mx-auto px-4 py-6">
        <!-- Header -->
        <header class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-black text-white rounded-full text-2xl font-bold mb-4">
                AI
            </div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">èŒåœºæˆé•¿AIåŠ©æ‰‹</h1>
            <p class="text-gray-600 max-w-2xl mx-auto">åŸºäºã€Šè¿œè§ã€‹ã€Šç²¾åŠ›ç®¡ç†ã€‹ã€ŠæŒæ§ä¹ æƒ¯ã€‹ç­‰ä¸“ä¸šä¹¦ç±ï¼Œä¸ºä½ æä¾›ä¸ªæ€§åŒ–èŒåœºå»ºè®®</p>
        </header>

        <!-- Status Indicator -->
        <div id="statusIndicator" class="mb-4 text-center">
            <div id="connectionStatus" class="inline-flex items-center px-3 py-1 rounded-full text-sm">
                <div class="w-2 h-2 rounded-full mr-2"></div>
                <span>æ­£åœ¨è¿æ¥...</span>
            </div>
        </div>

        <!-- Main Content Container -->
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <!-- Default Chat View -->
            <div id="chatView" class="block">
                <!-- Chat Messages -->
                <div id="chatContainer" class="h-96 overflow-y-auto p-6 space-y-4">
                    <!-- Messages will be added dynamically -->
                </div>

                <!-- Input Area -->
                <div class="border-t bg-gray-50 p-4">
                    <div class="flex space-x-3">
                        <input 
                            type="text" 
                            id="messageInput" 
                            placeholder="è¯·è¾“å…¥ä½ æƒ³è¦çš„èŒåœºæˆé•¿è®¡åˆ’ï¼Œæ¯”å¦‚ï¼šå¸®æˆ‘åˆ¶å®šæ–°äººå¿«é€Ÿèå…¥å›¢é˜Ÿçš„7å¤©è®¡åˆ’"
                            class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent"
                            onkeypress="handleKeyPress(event)"
                        >
                        <button 
                            onclick="sendMessage()" 
                            id="sendButton"
                            class="bg-black text-white px-6 py-2 rounded-lg hover:bg-gray-800 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            ç”Ÿæˆè®¡åˆ’
                        </button>
                    </div>
                    <div class="mt-3 flex flex-wrap gap-2">
                        <button onclick="quickSend('å¸®æˆ‘åˆ¶å®šæ–°äººå¿«é€Ÿèå…¥å›¢é˜Ÿçš„7å¤©è®¡åˆ’')" class="text-xs bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full transition-colors">
                            æ–°äººèå…¥å›¢é˜Ÿè®¡åˆ’
                        </button>
                        <button onclick="quickSend('åˆ¶å®šé«˜æ•ˆæ±‡æŠ¥å·¥ä½œçš„è®­ç»ƒè®¡åˆ’')" class="text-xs bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full transition-colors">
                            é«˜æ•ˆæ±‡æŠ¥è®­ç»ƒ
                        </button>
                        <button onclick="quickSend('å‹åŠ›ç®¡ç†å’Œæƒ…ç»ªè°ƒèŠ‚çš„å®è·µè®¡åˆ’')" class="text-xs bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full transition-colors">
                            å‹åŠ›ç®¡ç†è®¡åˆ’
                        </button>
                        <button onclick="quickSend('èŒåœºäººè„‰å»ºè®¾çš„è¡ŒåŠ¨æ–¹æ¡ˆ')" class="text-xs bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full transition-colors">
                            äººè„‰å»ºè®¾æ–¹æ¡ˆ
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading Animation View -->
            <div id="loadingView" class="hidden p-8 text-center h-96 flex flex-col justify-center">
                <div class="mb-6">
                    <div class="inline-flex items-center justify-center w-16 h-16 bg-black text-white rounded-full text-2xl font-bold mb-4 animate-pulse">
                        ğŸ“š
                    </div>
                    <div class="text-xl font-bold text-gray-900 mb-2">æ­£åœ¨ä¸ºä½ ç²¾é€‰å…¨çƒå¥½ä¹¦</div>
                    <div class="text-gray-600 mb-4">æŒ–æ˜çƒ­é—¨æ’­å®¢å’Œä¸“ä¸šå†…å®¹</div>
                </div>
                
                <div class="space-y-3 mb-6">
                    <div class="flex items-center justify-center space-x-2">
                        <div class="w-2 h-2 bg-black rounded-full animate-bounce"></div>
                        <div class="w-2 h-2 bg-black rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                        <div class="w-2 h-2 bg-black rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                    </div>
                    <div id="loadingMessage" class="text-sm text-gray-500">æ­£åœ¨åˆ†æä½ çš„éœ€æ±‚...</div>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="text-xs text-gray-400 mb-2">å³å°†ä¸ºä½ ç”Ÿæˆ</div>
                    <div class="text-sm font-medium text-gray-700">ä¸ªæ€§åŒ–èŒåœºæˆé•¿è®¡åˆ’</div>
                </div>
            </div>

            <!-- Subscription List View -->
            <div id="subscriptionView" class="hidden">
                <div class="p-6 border-b">
                    <div class="flex justify-between items-center mb-3">
                        <button onclick="startNewConversation()" class="text-sm text-gray-500 hover:text-gray-700 flex items-center">
                            â† ç”Ÿæˆæ–°è®¡åˆ’
                        </button>
                        <button onclick="clearChat()" class="text-xs text-gray-400 hover:text-gray-600">
                            æ¸…ç©ºå¯¹è¯
                        </button>
                    </div>
                    <div id="planTitle" class="text-2xl font-bold text-gray-900 mb-2">èŒåœºæˆé•¿è®¡åˆ’</div>
                    <div id="planDescription" class="text-gray-600 mb-4">ä¸ºä½ é‡èº«å®šåˆ¶çš„èŒåœºæŠ€èƒ½æå‡æ–¹æ¡ˆ</div>
                    <div class="flex items-center space-x-4 text-sm text-gray-500">
                        <span id="planDuration">7å¤©è®¡åˆ’</span>
                        <span>â€¢</span>
                        <span>æ¯æ—¥ç²¾é€‰å†…å®¹</span>
                    </div>
                </div>
                
                <div class="h-80 overflow-y-auto">
                    <div id="dailyContentList" class="p-6 space-y-3">
                        <!-- Daily content items will be added here -->
                    </div>
                </div>
            </div>

            <!-- Content Detail View -->
            <div id="contentDetailView" class="hidden h-96 overflow-y-auto">
                <!-- Content detail will be rendered here -->
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center mt-8">
            <div class="text-sm text-gray-500 mb-4">
                <p>æœ¬AIåŠ©æ‰‹åŸºäºä¸“ä¸šèŒåœºä¹¦ç±è®­ç»ƒï¼Œæä¾›çš„å»ºè®®ä»…ä¾›å‚è€ƒ</p>
            </div>
            <div class="flex justify-center space-x-4 text-xs text-gray-400">
                <span>å¯¹è¯æ•°: <span id="messageCount">0</span></span>
                <span>|</span>
                <span>å“åº”æ—¶é—´: <span id="avgResponseTime">--</span>ms</span>
            </div>
        </footer>
    </div>

    <script>
        // å±è”½Tailwindç”Ÿäº§ç¯å¢ƒè­¦å‘Š
        if (typeof console !== 'undefined') {
            const originalWarn = console.warn;
            console.warn = function(...args) {
                if (args[0] && args[0].includes('cdn.tailwindcss.com should not be used in production')) {
                    return;
                }
                originalWarn.apply(console, args);
            };
        }

        // Dify API é…ç½®
        const DIFY_CONFIG = {
            apiKey: 'app-NYGCC4ds6K1p6hNltnGLo1lT',
            baseUrl: 'http://ops.pd.ximalaya.local/dify/v1',
        };

        // å…¨å±€çŠ¶æ€ç®¡ç† - æ”¹è¿›ç‰ˆ
        let conversationId = null;
        let isLoading = false;
        let messageCount = 0;
        let responseTimes = [];
        let retryCount = 0;
        const MAX_RETRIES = 3;
        
        // æ–°å¢ï¼šè®¡åˆ’æ•°æ®ç®¡ç†
        let currentPlan = null;
        let currentView = 'chat'; // 'chat', 'loading', 'subscription', 'detail'
        
        // å¤šè½®å¯¹è¯çŠ¶æ€ç®¡ç†
        let conversationPhase = 'initial'; // 'initial', 'collecting', 'confirming', 'generating', 'completed'
        let planGenerationInProgress = false;

        // æœ¬åœ°å­˜å‚¨é”®å
        const STORAGE_KEYS = {
            CONVERSATION_ID: 'dify_conversation_id',
            MESSAGE_HISTORY: 'dify_message_history',
            USER_ID: 'dify_user_id'
        };

        // ç”Ÿæˆå”¯ä¸€ç”¨æˆ·ID
        function generateUserId() {
            return 'user-' + Math.random().toString(36).substr(2, 9) + '-' + Date.now();
        }

        // è·å–æˆ–åˆ›å»ºç”¨æˆ·ID
        function getUserId() {
            let userId = localStorage.getItem(STORAGE_KEYS.USER_ID);
            if (!userId) {
                userId = generateUserId();
                localStorage.setItem(STORAGE_KEYS.USER_ID, userId);
            }
            return userId;
        }

        // ä¿å­˜ä¼šè¯IDåˆ°æœ¬åœ°å­˜å‚¨
        function saveConversationId(id) {
            conversationId = id;
            if (id) {
                localStorage.setItem(STORAGE_KEYS.CONVERSATION_ID, id);
                console.log('ä¿å­˜ä¼šè¯IDåˆ°æœ¬åœ°å­˜å‚¨:', id);
            }
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ä¼šè¯ID
        function loadConversationId() {
            const savedId = localStorage.getItem(STORAGE_KEYS.CONVERSATION_ID);
            if (savedId) {
                conversationId = savedId;
                console.log('ä»æœ¬åœ°å­˜å‚¨åŠ è½½ä¼šè¯ID:', savedId);
            }
            return savedId;
        }

        // æ¸…é™¤ä¼šè¯æ•°æ®
        function clearConversationData() {
            conversationId = null;
            localStorage.removeItem(STORAGE_KEYS.CONVERSATION_ID);
            localStorage.removeItem(STORAGE_KEYS.MESSAGE_HISTORY);
            console.log('æ¸…é™¤ä¼šè¯æ•°æ®');
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // åŠ è½½ä¿å­˜çš„ä¼šè¯ID
            loadConversationId();
            
            document.getElementById('messageInput').focus();
            updateConnectionStatus('loading', 'åˆå§‹åŒ–ä¸­...');
            
            // å»¶è¿Ÿæµ‹è¯•è¿æ¥ï¼Œé¿å…é¡µé¢åŠ è½½æ—¶çš„ç½‘ç»œé—®é¢˜
            setTimeout(() => {
                testConnection();
            }, 500);
        }

        // æµ‹è¯•è¿æ¥åŠŸèƒ½ - æ”¹è¿›ç‰ˆ
        async function testConnection() {
            try {
                updateConnectionStatus('loading', 'æµ‹è¯•è¿æ¥ä¸­...');
                
                // ä½¿ç”¨ç®€å•çš„å‚æ•°æµ‹è¯•è¿æ¥
                const userId = getUserId();
                const testResponse = await fetch(`${DIFY_CONFIG.baseUrl}/chat-messages`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${DIFY_CONFIG.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        inputs: {
                            user_id: userId
                        },
                        query: "hello",
                        response_mode: "blocking",
                        user: userId
                    })
                });
                
                if (testResponse.ok) {
                    const data = await testResponse.json();
                    // å¦‚æœæµ‹è¯•æˆåŠŸï¼Œä¿å­˜è¿”å›çš„conversation_id
                    if (data.conversation_id) {
                        saveConversationId(data.conversation_id);
                    }
                    updateConnectionStatus('connected', 'AIåŠ©æ‰‹å·²å°±ç»ª');
                    retryCount = 0;
                    
                    // æ·»åŠ æ¬¢è¿æ¶ˆæ¯åˆ°ç•Œé¢
                    addMessage("ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„èŒåœºæˆé•¿AIåŠ©æ‰‹ã€‚\n\næˆ‘å¯ä»¥ä¸ºä½ ç”Ÿæˆä¸ªæ€§åŒ–çš„èŒåœºæŠ€èƒ½æå‡è®¡åˆ’ï¼Œæ¯”å¦‚ï¼š\nâ€¢ æ–°äººå¿«é€Ÿèå…¥å›¢é˜Ÿè®¡åˆ’\nâ€¢ é«˜æ•ˆæ±‡æŠ¥è®­ç»ƒæ–¹æ¡ˆ\nâ€¢ å‹åŠ›ç®¡ç†å®è·µæŒ‡å—\nâ€¢ èŒåœºäººè„‰å»ºè®¾ç­–ç•¥\n\nè¯·å‘Šè¯‰æˆ‘ä½ æƒ³è¦ä»€ä¹ˆæ ·çš„è®¡åˆ’ï¼", 'assistant');
                    
                } else {
                    const errorText = await testResponse.text();
                    console.error('è¿æ¥æµ‹è¯•å¤±è´¥:', errorText);
                    throw new Error(`è¿æ¥æµ‹è¯•å¤±è´¥: ${testResponse.status} - ${errorText}`);
                }
            } catch (error) {
                console.error('è¿æ¥æµ‹è¯•å¤±è´¥:', error);
                updateConnectionStatus('error', 'è¿æ¥å¤±è´¥');
                
                // æ ¹æ®é”™è¯¯ç±»å‹æä¾›ä¸åŒçš„è§£å†³å»ºè®®
                let errorMsg = 'âš ï¸ è¿æ¥å¤±è´¥ã€‚\n\n';
                if (error.message.includes('404')) {
                    errorMsg += 'å¯èƒ½åŸå› ï¼š\n1. APIç«¯ç‚¹URLä¸æ­£ç¡®\n2. åº”ç”¨IDæˆ–APIå¯†é’¥æœ‰è¯¯\n3. DifyæœåŠ¡æœªæ­£ç¡®é…ç½®';
                } else if (error.message.includes('fetch')) {
                    errorMsg += 'å¯èƒ½åŸå› ï¼š\n1. ç½‘ç»œè¿æ¥é—®é¢˜\n2. æœåŠ¡å™¨åœ°å€ä¸å¯è®¿é—®\n3. é˜²ç«å¢™æˆ–ä»£ç†é˜»æ­¢\n4. CORSè·¨åŸŸé™åˆ¶';
                } else {
                    errorMsg += `é”™è¯¯è¯¦æƒ…: ${error.message}`;
                }
                
                addMessage(errorMsg, 'assistant', true);
            }
        }

        function updateConnectionStatus(status = 'connected', message = 'AIåŠ©æ‰‹å·²å°±ç»ª') {
            const statusEl = document.getElementById('connectionStatus');
            if (!statusEl) return;
            
            const dot = statusEl.querySelector('div');
            const text = statusEl.querySelector('span');
            
            if (!dot || !text) return;
            
            // æ¸…é™¤ç°æœ‰æ ·å¼
            statusEl.className = 'inline-flex items-center px-3 py-1 rounded-full text-sm';
            dot.className = 'w-2 h-2 rounded-full mr-2';
            
            switch(status) {
                case 'connected':
                    statusEl.classList.add('bg-green-100', 'text-green-800');
                    dot.classList.add('bg-green-500');
                    break;
                case 'loading':
                    statusEl.classList.add('bg-yellow-100', 'text-yellow-800');
                    dot.classList.add('bg-yellow-500');
                    break;
                case 'error':
                    statusEl.classList.add('bg-red-100', 'text-red-800');
                    dot.classList.add('bg-red-500');
                    break;
                default:
                    statusEl.classList.add('bg-gray-100', 'text-gray-800');
                    dot.classList.add('bg-gray-500');
            }
            
            text.textContent = message;
        }

        // å¤„ç†å›è½¦é”®å‘é€
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // å¿«é€Ÿå‘é€é¢„è®¾é—®é¢˜
        function quickSend(message) {
            document.getElementById('messageInput').value = message;
            sendMessage();
        }

        // è§†å›¾åˆ‡æ¢å‡½æ•°
        function showView(viewName) {
            const views = ['chatView', 'loadingView', 'subscriptionView', 'contentDetailView'];
            views.forEach(view => {
                const element = document.getElementById(view);
                if (element) {
                    element.classList.add('hidden');
                }
            });
            
            const targetView = document.getElementById(viewName);
            if (targetView) {
                targetView.classList.remove('hidden');
            }
            
            currentView = viewName.replace('View', '');
        }

        function showChatView() {
            showView('chatView');
        }

        // é‡ç½®å¯¹è¯çŠ¶æ€
        function resetConversationState() {
            conversationPhase = 'initial';
            planGenerationInProgress = false;
            currentPlan = null;
        }

        // å¼€å§‹æ–°å¯¹è¯
        function startNewConversation() {
            resetConversationState();
            showChatView();
            document.getElementById('messageInput').focus();
        }

        function showLoadingView() {
            showView('loadingView');
            // å¯åŠ¨åŠ è½½æ¶ˆæ¯è½®æ’­
            startLoadingMessages();
        }

        function showSubscriptionView() {
            showView('subscriptionView');
        }

        function showContentDetailView(dayIndex) {
            showView('contentDetailView');
            renderContentDetail(dayIndex);
        }

        // åŠ è½½æ¶ˆæ¯è½®æ’­ - æ ¹æ®å¯¹è¯é˜¶æ®µæ™ºèƒ½æ˜¾ç¤º
        function startLoadingMessages() {
            const messagesByPhase = {
                collecting: [
                    'æ­£åœ¨åˆ†æä½ çš„éœ€æ±‚...',
                    'ç†è§£ä½ çš„èŒåœºç›®æ ‡...',
                    'è¯„ä¼°ä½ çš„å½“å‰æƒ…å†µ...'
                ],
                confirming: [
                    'æ­£åœ¨ç¡®è®¤è®¡åˆ’ç»†èŠ‚...',
                    'è°ƒæ•´ä¸ªæ€§åŒ–è®¾ç½®...',
                    'å‡†å¤‡å¼€å§‹ç”Ÿæˆ...'
                ],
                generating: [
                    'æ­£åœ¨ä¸ºä½ ç²¾é€‰å…¨çƒå¥½ä¹¦...',
                    'æŒ–æ˜çƒ­é—¨æ’­å®¢å†…å®¹...',
                    'æ•´åˆä¸“ä¸šçŸ¥è¯†ç‚¹...',
                    'å®šåˆ¶ä¸ªæ€§åŒ–æ–¹æ¡ˆ...',
                    'ç”Ÿæˆæ¯æ—¥è¡ŒåŠ¨æŒ‡å—...',
                    'å³å°†å®Œæˆä½ çš„è®¡åˆ’...'
                ]
            };
            
            const messages = messagesByPhase[conversationPhase] || messagesByPhase.generating;
            let index = 0;
            const messageEl = document.getElementById('loadingMessage');
            
            // ç«‹å³æ˜¾ç¤ºç¬¬ä¸€æ¡æ¶ˆæ¯
            if (messageEl) {
                messageEl.textContent = messages[0];
            }
            
            const interval = setInterval(() => {
                if (currentView !== 'loading') {
                    clearInterval(interval);
                    return;
                }
                
                index = (index + 1) % messages.length;
                if (messageEl) {
                    messageEl.textContent = messages[index];
                }
            }, 2000);
        }

        // å‘é€æ¶ˆæ¯ - æ”¹è¿›ç‰ˆæ”¯æŒå¤šè½®å¯¹è¯
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || isLoading) return;

            // æ¸…ç©ºè¾“å…¥æ¡†
            input.value = '';
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©
            addMessage(message, 'user');
            
            // æ ¹æ®å¯¹è¯é˜¶æ®µå†³å®šUIæ˜¾ç¤º
            if (conversationPhase === 'initial' && !planGenerationInProgress) {
                // ç¬¬ä¸€æ¬¡è¯¢é—®ï¼Œåˆ¤æ–­æ˜¯å¦å¯èƒ½å¼€å§‹è®¡åˆ’ç”Ÿæˆ
                if (isPlanGenerationRequest(message)) {
                    planGenerationInProgress = true;
                    conversationPhase = 'collecting';
                }
            }
            
            // æ˜¾ç¤ºé€‚å½“çš„åŠ è½½çŠ¶æ€
            if (planGenerationInProgress && shouldShowLoadingAnimation()) {
                showLoadingView();
                updateConnectionStatus('loading', getLoadingMessage());
            } else {
                showTypingIndicator();
                updateConnectionStatus('loading', 'æ­£åœ¨æ€è€ƒ...');
            }
            
            const startTime = Date.now();
            
            try {
                isLoading = true;
                updateSendButton(true);
                
                // è°ƒç”¨Dify API - ä½¿ç”¨æ”¹è¿›çš„é‡è¯•æœºåˆ¶
                const response = await callDifyAPIWithRetry(message);
                
                const endTime = Date.now();
                const responseTime = endTime - startTime;
                responseTimes.push(responseTime);
                
                // å¤„ç†å“åº” - æ”¯æŒå¤šè½®å¯¹è¯
                if (response && response.answer) {
                    // ä¿å­˜æ–°çš„conversation_idï¼ˆå¦‚æœæœ‰ï¼‰
                    if (response.conversation_id) {
                        saveConversationId(response.conversation_id);
                    }
                    
                    // æ ¹æ®å¯¹è¯é˜¶æ®µå’Œå†…å®¹åˆ¤æ–­ä¸‹ä¸€æ­¥
                    handleConversationResponse(response.answer, message);
                    
                } else {
                    // å›åˆ°èŠå¤©è§†å›¾æ˜¾ç¤ºé”™è¯¯
                    if (currentView === 'loading') {
                        showChatView();
                    }
                    removeTypingIndicator();
                    addMessage('æŠ±æ­‰ï¼Œæˆ‘æ²¡æœ‰æ”¶åˆ°æœ‰æ•ˆçš„å›å¤ã€‚è¯·é‡è¯•ã€‚', 'assistant', true);
                }
                
                // æ›´æ–°ç»Ÿè®¡
                messageCount++;
                updateStats();
                updateConnectionStatus('connected', 'AIåŠ©æ‰‹å·²å°±ç»ª');
                
                // é‡ç½®é‡è¯•è®¡æ•°
                retryCount = 0;
                
            } catch (error) {
                console.error('APIè°ƒç”¨å¤±è´¥:', error);
                
                // å›åˆ°èŠå¤©è§†å›¾æ˜¾ç¤ºé”™è¯¯
                showChatView();
                
                // æ ¹æ®é”™è¯¯ç±»å‹æä¾›ä¸åŒçš„å¤„ç†
                let errorMessage = 'æŠ±æ­‰ï¼Œæˆ‘ç°åœ¨æ— æ³•ç”Ÿæˆè®¡åˆ’ã€‚';
                let shouldClearConversation = false;
                
                if (error.message.includes('Conversation Not Exists')) {
                    errorMessage = 'âš ï¸ ä¼šè¯å·²è¿‡æœŸï¼Œæ­£åœ¨åˆ›å»ºæ–°çš„å¯¹è¯...';
                    shouldClearConversation = true;
                } else if (error.message.includes('401')) {
                    errorMessage = 'âš ï¸ APIå¯†é’¥éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®ã€‚';
                } else if (error.message.includes('404')) {
                    errorMessage = 'âš ï¸ APIç«¯ç‚¹ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨é…ç½®ã€‚';
                    shouldClearConversation = true;
                } else if (error.message.includes('429')) {
                    errorMessage = 'âš ï¸ è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•ã€‚';
                } else if (error.message.includes('fetch') || error.message.includes('network')) {
                    errorMessage = 'âš ï¸ ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œçŠ¶æ€æˆ–ç¨åé‡è¯•ã€‚';
                } else {
                    errorMessage = `âš ï¸ è¯·æ±‚å¤±è´¥: ${error.message}`;
                }
                
                addMessage(errorMessage, 'assistant', true);
                updateConnectionStatus('error', 'è¿æ¥å¤±è´¥');
                
                // å¦‚æœæ˜¯ä¼šè¯ç›¸å…³é”™è¯¯ï¼Œæ¸…é™¤ä¼šè¯æ•°æ®å¹¶é‡è¯•
                if (shouldClearConversation) {
                    clearConversationData();
                    
                    // 3ç§’åè‡ªåŠ¨é‡è¯•
                    setTimeout(async () => {
                        try {
                            addMessage('æ­£åœ¨é‡æ–°å»ºç«‹è¿æ¥...', 'assistant');
                            showTypingIndicator();
                            
                            const retryResponse = await callDifyAPI(message);
                            removeTypingIndicator();
                            
                            if (retryResponse && retryResponse.answer) {
                                addMessage(retryResponse.answer, 'assistant');
                                if (retryResponse.conversation_id) {
                                    saveConversationId(retryResponse.conversation_id);
                                }
                                updateConnectionStatus('connected', 'AIåŠ©æ‰‹å·²å°±ç»ª');
                            }
                        } catch (retryError) {
                            console.error('é‡è¯•å¤±è´¥:', retryError);
                            removeTypingIndicator();
                            addMessage('é‡æ–°è¿æ¥å¤±è´¥ï¼Œè¯·ç¨åæ‰‹åŠ¨é‡è¯•ã€‚', 'assistant', true);
                        }
                    }, 3000);
                }
                
            } finally {
                isLoading = false;
                updateSendButton(false);
            }
        }

        // å¸¦é‡è¯•æœºåˆ¶çš„APIè°ƒç”¨ - æ”¹è¿›ç‰ˆ
        async function callDifyAPIWithRetry(query) {
            let lastError;
            
            for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
                try {
                    console.log(`å°è¯•ç¬¬ ${attempt} æ¬¡è°ƒç”¨API...`);
                    
                    // å¦‚æœä¸æ˜¯ç¬¬ä¸€æ¬¡å°è¯•ï¼Œç­‰å¾…ä¸€ä¸‹å†é‡è¯•
                    if (attempt > 1) {
                        await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                    }
                    
                    const response = await callDifyAPI(query);
                    console.log(`APIè°ƒç”¨æˆåŠŸï¼Œç¬¬ ${attempt} æ¬¡å°è¯•`);
                    return response;
                    
                } catch (error) {
                    console.error(`ç¬¬ ${attempt} æ¬¡å°è¯•å¤±è´¥:`, error);
                    lastError = error;
                    
                    // å¦‚æœæ˜¯ä¼šè¯ä¸å­˜åœ¨çš„é”™è¯¯ï¼Œæ¸…é™¤ä¼šè¯æ•°æ®åé‡è¯•
                    if (error.message.includes('Conversation Not Exists') && attempt < MAX_RETRIES) {
                        console.log('æ£€æµ‹åˆ°ä¼šè¯ä¸å­˜åœ¨ï¼Œæ¸…é™¤ä¼šè¯æ•°æ®åé‡è¯•...');
                        clearConversationData();
                        continue;
                    }
                    
                    // å¦‚æœæ˜¯æœ€åä¸€æ¬¡å°è¯•ï¼ŒæŠ›å‡ºé”™è¯¯
                    if (attempt === MAX_RETRIES) {
                        throw error;
                    }
                    
                    // æ›´æ–°çŠ¶æ€æ˜¾ç¤ºé‡è¯•ä¿¡æ¯
                    updateConnectionStatus('loading', `é‡è¯•ä¸­... (${attempt}/${MAX_RETRIES})`);
                }
            }
            
            throw lastError;
        }

        // è°ƒç”¨Dify API - æ”¹è¿›ç‰ˆ
        async function callDifyAPI(query) {
            const url = `${DIFY_CONFIG.baseUrl}/chat-messages`;
            const userId = getUserId();
            
            const requestBody = {
                inputs: {
                    user_id: userId
                },
                query: query,
                response_mode: "blocking",
                user: userId
            };

            // å¦‚æœæœ‰conversation_idï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
            if (conversationId) {
                requestBody.conversation_id = conversationId;
                console.log('ä½¿ç”¨ç°æœ‰ä¼šè¯ID:', conversationId);
            } else {
                console.log('åˆ›å»ºæ–°ä¼šè¯');
            }

            console.log('å‘é€è¯·æ±‚åˆ°:', url);
            console.log('è¯·æ±‚ä½“:', requestBody);
            console.log('ç”¨æˆ·ID:', userId);

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${DIFY_CONFIG.apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            console.log('å“åº”çŠ¶æ€:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('APIé”™è¯¯å“åº”:', errorText);
                
                // å°è¯•è§£æé”™è¯¯ä¿¡æ¯
                let errorData;
                try {
                    errorData = JSON.parse(errorText);
                } catch (e) {
                    errorData = { message: errorText };
                }
                
                if (response.status === 401) {
                    throw new Error('APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ');
                } else if (response.status === 403) {
                    throw new Error('APIè®¿é—®è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥æƒé™');
                } else if (response.status === 404) {
                    if (errorData.message && errorData.message.includes('Conversation Not Exists')) {
                        throw new Error('Conversation Not Exists');
                    } else {
                        throw new Error('APIç«¯ç‚¹ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥URLé…ç½®');
                    }
                } else if (response.status === 500) {
                    throw new Error('æœåŠ¡å™¨å†…éƒ¨é”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                } else if (response.status === 429) {
                    throw new Error('è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åé‡è¯•');
                } else {
                    throw new Error(`HTTP ${response.status}: ${errorData.message || response.statusText}`);
                }
            }

            const data = await response.json();
            console.log('APIå“åº”æ•°æ®:', data);
            
            // ä¿å­˜conversation_idç”¨äºåç»­å¯¹è¯
            if (data.conversation_id) {
                saveConversationId(data.conversation_id);
                console.log('ä¿å­˜æ–°ä¼šè¯ID:', data.conversation_id);
            }

            return data;
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessage(content, role, isError = false) {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-bubble';
            
            if (role === 'user') {
                messageDiv.innerHTML = `
                    <div class="flex items-start space-x-3 justify-end">
                        <div class="flex-1 text-right">
                            <div class="bg-black text-white rounded-lg p-3 max-w-2xl ml-auto shadow-md">
                                <div class="text-sm message-content">${escapeHtml(content)}</div>
                            </div>
                        </div>
                        <div class="flex-shrink-0 w-8 h-8 bg-gray-600 text-white rounded-full flex items-center justify-center text-sm font-bold">
                            ä½ 
                        </div>
                    </div>
                `;
            } else {
                const bgColor = isError ? 'bg-red-50 border-red-200' : 'bg-white border-gray-200';
                const textColor = isError ? 'text-red-800' : 'text-gray-800';
                
                messageDiv.innerHTML = `
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 w-8 h-8 bg-black text-white rounded-full flex items-center justify-center text-sm font-bold">
                            AI
                        </div>
                        <div class="flex-1">
                            <div class="${bgColor} rounded-lg p-4 max-w-2xl shadow-sm border">
                                <div class="text-sm ${textColor} message-content">${formatMessage(content)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // æ˜¾ç¤ºè¾“å…¥æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;
            
            const startTime = Date.now();
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'chat-bubble';
            typingDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <div class="flex-shrink-0 w-8 h-8 bg-black text-white rounded-full flex items-center justify-center text-sm font-bold">
                        AI
                    </div>
                    <div class="flex-1">
                        <div class="bg-white rounded-lg p-3 max-w-md border shadow-sm">
                            <div class="typing-indicator">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                            <div class="text-xs text-gray-500 mt-2" id="waitingTime">ç­‰å¾…ä¸­...</div>
                        </div>
                    </div>
                </div>
            `;
            
            // æ·»åŠ ç­‰å¾…æ—¶é—´æ›´æ–°
            const waitingTimeEl = typingDiv.querySelector('#waitingTime');
            const timer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                waitingTimeEl.textContent = `ç­‰å¾…ä¸­... ${elapsed}s`;
            }, 1000);
            
            // ä¿å­˜timerå¼•ç”¨ä»¥ä¾¿æ¸…é™¤
            typingDiv.dataset.timer = timer;
            
            chatContainer.appendChild(typingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                // æ¸…é™¤å®šæ—¶å™¨
                if (typingIndicator.dataset.timer) {
                    clearInterval(typingIndicator.dataset.timer);
                }
                typingIndicator.remove();
            }
        }

        // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
        function updateSendButton(loading) {
            const button = document.getElementById('sendButton');
            const input = document.getElementById('messageInput');
            
            if (!button || !input) return;
            
            if (loading) {
                button.textContent = 'å‘é€ä¸­...';
                button.disabled = true;
                input.disabled = true;
            } else {
                button.textContent = 'å‘é€';
                button.disabled = false;
                input.disabled = false;
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const messageCountEl = document.getElementById('messageCount');
            const avgResponseTimeEl = document.getElementById('avgResponseTime');
            
            if (messageCountEl) {
                messageCountEl.textContent = messageCount;
            }
            
            if (avgResponseTimeEl && responseTimes.length > 0) {
                const avgTime = Math.round(responseTimes.reduce((a, b) => a + b, 0) / responseTimes.length);
                avgResponseTimeEl.textContent = avgTime;
            }
        }

        // è½¬ä¹‰HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ ¼å¼åŒ–æ¶ˆæ¯
        function formatMessage(text) {
            text = escapeHtml(text);
            text = text.replace(/\n/g, '<br>');
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            text = text.replace(/^- (.*$)/gm, 'â€¢ $1');
            return text;
        }

        // æ¸…ç©ºèŠå¤© - æ”¹è¿›ç‰ˆ
        function clearChat() {
            const chatContainer = document.getElementById('chatContainer');
            if (!chatContainer) return;
            
            // æ¸…é™¤ä¼šè¯æ•°æ®å’Œå¯¹è¯çŠ¶æ€
            clearConversationData();
            resetConversationState();
            
            // å›åˆ°èŠå¤©è§†å›¾
            showChatView();
            
            chatContainer.innerHTML = `
                <div class="chat-bubble">
                    <div class="flex items-start space-x-3">
                        <div class="flex-shrink-0 w-8 h-8 bg-black text-white rounded-full flex items-center justify-center text-sm font-bold">
                            AI
                        </div>
                        <div class="flex-1">
                            <div class="bg-white rounded-lg p-4 max-w-2xl shadow-sm border">
                                <div class="text-sm text-gray-800 message-content">
                                    <p>å¯¹è¯å·²æ¸…ç©ºï¼Œæˆ‘ä»¬é‡æ–°å¼€å§‹å§ï¼è¯·å‘Šè¯‰æˆ‘ä½ æƒ³è¦ä»€ä¹ˆæ ·çš„èŒåœºæˆé•¿è®¡åˆ’ï¼</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // é‡ç½®çŠ¶æ€
            messageCount = 0;
            responseTimes = [];
            retryCount = 0;
            updateStats();
            updateConnectionStatus('connected', 'AIåŠ©æ‰‹å·²å°±ç»ª');
        }

        // é‡æ–°è¿æ¥åŠŸèƒ½ - æ”¹è¿›ç‰ˆ
        function reconnect() {
            console.log('å°è¯•é‡æ–°è¿æ¥...');
            clearConversationData();
            updateConnectionStatus('loading', 'é‡æ–°è¿æ¥ä¸­...');
            
            // å»¶è¿Ÿé‡æ–°æµ‹è¯•è¿æ¥
            setTimeout(() => {
                testConnection();
            }, 1000);
        }

        // æ·»åŠ è°ƒè¯•åŠŸèƒ½
        function debugInfo() {
            console.log('=== è°ƒè¯•ä¿¡æ¯ ===');
            console.log('Conversation ID:', conversationId);
            console.log('User ID:', getUserId());
            console.log('API Config:', DIFY_CONFIG);
            console.log('Local Storage:', {
                conversationId: localStorage.getItem(STORAGE_KEYS.CONVERSATION_ID),
                userId: localStorage.getItem(STORAGE_KEYS.USER_ID)
            });
            console.log('===============');
        }

        // åˆ¤æ–­æ˜¯å¦ä¸ºè®¡åˆ’ç”Ÿæˆè¯·æ±‚
        function isPlanGenerationRequest(message) {
            const planKeywords = ['è®¡åˆ’', 'æ–¹æ¡ˆ', 'è®­ç»ƒ', 'æŒ‡å¯¼', 'å¸®åŠ©', 'åˆ¶å®š', 'å­¦ä¹ ', 'æå‡'];
            const workplaceKeywords = ['èŒåœº', 'å·¥ä½œ', 'å›¢é˜Ÿ', 'æ±‡æŠ¥', 'æ²Ÿé€š', 'å‹åŠ›', 'äººè„‰', 'æ–°äºº'];
            
            return planKeywords.some(keyword => message.includes(keyword)) && 
                   workplaceKeywords.some(keyword => message.includes(keyword));
        }

        // åˆ¤æ–­æ˜¯å¦åº”è¯¥æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
        function shouldShowLoadingAnimation() {
            return conversationPhase === 'generating' || 
                   (conversationPhase === 'confirming' && isResponseLikelyFinalPlan());
        }

        // è·å–åŠ è½½æ¶ˆæ¯
        function getLoadingMessage() {
            switch(conversationPhase) {
                case 'collecting': return 'æ­£åœ¨æ”¶é›†éœ€æ±‚...';
                case 'confirming': return 'æ­£åœ¨ç¡®è®¤ç»†èŠ‚...';
                case 'generating': return 'æ­£åœ¨ç”Ÿæˆä¸ªæ€§åŒ–è®¡åˆ’...';
                default: return 'æ­£åœ¨å¤„ç†...';
            }
        }

        // æ£€æŸ¥å›å¤æ˜¯å¦å¯èƒ½æ˜¯æœ€ç»ˆè®¡åˆ’
        function isResponseLikelyFinalPlan() {
            // è¿™ä¸ªå‡½æ•°ä¼šåœ¨æ”¶åˆ°å›å¤åè°ƒç”¨ï¼Œæš‚æ—¶è¿”å›false
            return false;
        }

        // å¤„ç†å¯¹è¯å“åº”çš„æ ¸å¿ƒé€»è¾‘
        function handleConversationResponse(answer, userMessage) {
            console.log('=== å¤„ç†å¯¹è¯å“åº” ===');
            console.log('å›å¤é•¿åº¦:', answer.length);
            console.log('å½“å‰å¯¹è¯é˜¶æ®µ:', conversationPhase);
            console.log('å›å¤å‰100å­—ç¬¦:', answer.substring(0, 100));
            
            // ç§»é™¤åŠ è½½æŒ‡ç¤ºå™¨
            removeTypingIndicator();
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æœ€ç»ˆçš„è®¡åˆ’å†…å®¹
            const isFinal = isFinalPlan(answer);
            console.log('æ˜¯å¦ä¸ºæœ€ç»ˆè®¡åˆ’:', isFinal);
            
            if (isFinal) {
                console.log('âœ… è¯†åˆ«ä¸ºæœ€ç»ˆè®¡åˆ’ï¼Œå¼€å§‹è§£æå’Œæ¸²æŸ“');
                // è¿™æ˜¯æœ€ç»ˆè®¡åˆ’ï¼Œåˆ‡æ¢åˆ°è®¢é˜…è§†å›¾
                conversationPhase = 'completed';
                planGenerationInProgress = false;
                
                currentPlan = parsePlanData(answer, userMessage);
                console.log('è§£æåçš„è®¡åˆ’æ•°æ®:', currentPlan);
                
                renderPlanList(currentPlan);
                showSubscriptionView();
                
            } else {
                console.log('âŒ æœªè¯†åˆ«ä¸ºæœ€ç»ˆè®¡åˆ’ï¼Œç»§ç»­å¯¹è¯');
                // è¿™æ˜¯ä¸­é—´å¯¹è¯ï¼Œç»§ç»­åœ¨èŠå¤©è§†å›¾æ˜¾ç¤º
                if (currentView === 'loading') {
                    showChatView();
                }
                
                addMessage(answer, 'assistant');
                
                // æ›´æ–°å¯¹è¯é˜¶æ®µ
                updateConversationPhase(answer);
                
                // å¦‚æœæ£€æµ‹åˆ°å³å°†ç”Ÿæˆæœ€ç»ˆè®¡åˆ’ï¼Œå‡†å¤‡æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
                if (isAboutToGeneratePlan(answer)) {
                    conversationPhase = 'generating';
                }
            }
            
            console.log('=== å“åº”å¤„ç†å®Œæˆ ===');
        }

        // æ£€æŸ¥æ˜¯å¦ä¸ºæœ€ç»ˆè®¡åˆ’å†…å®¹ - é’ˆå¯¹difyæ ¼å¼ä¼˜åŒ–ï¼ˆæ›´å®½æ¾çš„æ£€æµ‹ï¼‰
        function isFinalPlan(answer) {
            console.log('æ£€æŸ¥æ˜¯å¦ä¸ºæœ€ç»ˆè®¡åˆ’ï¼Œå†…å®¹é•¿åº¦:', answer.length);
            
            // 1. æ£€æŸ¥æ˜¯å¦åŒ…å«è®¡åˆ’åç§°æ ¼å¼
            const hasPlanTitle = /è®¡åˆ’åç§°[ï¼š:]\s*ã€Š[^ã€‹]+ã€‹/.test(answer);
            
            // 2. æ£€æŸ¥æ˜¯å¦åŒ…å«å¤šä¸ªDayç»“æ„ï¼ˆé™ä½é˜ˆå€¼ï¼‰
            const dayPattern = /Day\s*\d+[Â·\s]/g;
            const dayMatches = answer.match(dayPattern);
            const hasDayStructure = dayMatches && dayMatches.length >= 1; // é™ä½åˆ°1ä¸ªå³å¯
            
            // 3. æ£€æŸ¥æ˜¯å¦åŒ…å«difyçš„ç»“æ„åŒ–å­—æ®µï¼ˆã€ã€‘æ ¼å¼ï¼‰
            const bracketFields = ['ã€æ ‡é¢˜ã€‘', 'ã€é‡‘å¥ã€‘', 'ã€å¯¼è¯­ã€‘', 'ã€å…³é”®åŸåˆ™ã€‘', 'ã€çœŸå®æ¡ˆä¾‹ã€‘', 'ã€ä»Šæ—¥æŒ‘æˆ˜ã€‘'];
            const structuredFieldsCount = bracketFields.filter(field => answer.includes(field)).length;
            const hasStructuredContent = structuredFieldsCount >= 3; // é™ä½åˆ°3ä¸ªå³å¯
            
            // 4. æ£€æŸ¥æ˜¯å¦åŒ…å«åˆ†éš”ç¬¦
            const hasSeparators = answer.includes('â€”â€”â€”â€”â€”â€”â€”â€”â€”');
            
            // 5. æ£€æŸ¥å†…å®¹é•¿åº¦ï¼ˆé™ä½é˜ˆå€¼ï¼‰
            const isLongContent = answer.length > 1000; // é™ä½åˆ°1000å­—ç¬¦
            
            // 6. æ£€æŸ¥æ˜¯å¦åŒ…å«ç›®æ ‡ã€é¢„æœŸæ•ˆæœç­‰è®¡åˆ’è¦ç´ 
            const hasPlanElements = answer.includes('ç›®æ ‡') || answer.includes('é¢„æœŸæ•ˆæœ');
            
            // 7. æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦åŒ…å«ç¬¬Xå¤©ã€Day Xç­‰æ¨¡å¼
            const hasChapterPattern = /ç¬¬\d+å¤©|Day\s*\d+/.test(answer);
            
            // 8. æ–°å¢ï¼šæ£€æŸ¥æ˜¯å¦åŒ…å«å¤šä¸ªã€ã€‘å­—æ®µ
            const bracketFieldCount = (answer.match(/ã€[^ã€‘]+ã€‘/g) || []).length;
            const hasManyBrackets = bracketFieldCount >= 5;
            
            // æ›´å®½æ¾çš„åˆ¤æ–­æ¡ä»¶
            const isFinal = hasPlanTitle || // æœ‰è®¡åˆ’åç§°å°±è®¤ä¸ºæ˜¯æœ€ç»ˆè®¡åˆ’
                           (hasStructuredContent && isLongContent) || // æœ‰ç»“æ„åŒ–å­—æ®µä¸”é•¿åº¦è¶³å¤Ÿ
                           (hasSeparators && hasChapterPattern) || // æœ‰åˆ†éš”ç¬¦ä¸”æœ‰ç« èŠ‚æ¨¡å¼
                           (hasManyBrackets && isLongContent) || // æœ‰å¾ˆå¤šã€ã€‘å­—æ®µä¸”å†…å®¹é•¿
                           (hasDayStructure && structuredFieldsCount >= 2); // æœ‰Dayç»“æ„ä¸”æœ‰ä¸€äº›ç»“æ„åŒ–å­—æ®µ
                           
            console.log('æœ€ç»ˆè®¡åˆ’æ£€æŸ¥ç»“æœ:', {
                hasPlanTitle,
                hasDayStructure,
                dayCount: dayMatches ? dayMatches.length : 0,
                hasStructuredContent,
                structuredFieldsCount,
                hasSeparators,
                isLongContent,
                hasPlanElements,
                hasChapterPattern,
                hasManyBrackets,
                bracketFieldCount,
                isFinal
            });
            
            return isFinal;
        }

        // æ›´æ–°å¯¹è¯é˜¶æ®µ
        function updateConversationPhase(answer) {
            if (answer.includes('è¿˜éœ€è¦') || answer.includes('è¯·å‘Šè¯‰æˆ‘') || answer.includes('æƒ³äº†è§£')) {
                conversationPhase = 'collecting';
            } else if (answer.includes('ç¡®è®¤') || answer.includes('å¼€å§‹ç”Ÿæˆ') || answer.includes('å‡†å¤‡ä¸ºä½ ')) {
                conversationPhase = 'confirming';
            }
        }

        // æ£€æŸ¥æ˜¯å¦å³å°†ç”Ÿæˆè®¡åˆ’
        function isAboutToGeneratePlan(answer) {
            const generationPhrases = [
                'å¼€å§‹ä¸ºä½ ç”Ÿæˆ', 'æ­£åœ¨åˆ¶å®š', 'é©¬ä¸Šä¸ºä½ å®šåˆ¶', 
                'å¼€å§‹åˆ›å»º', 'å³å°†ç”Ÿæˆ', 'å‡†å¤‡ç”Ÿæˆ'
            ];
            return generationPhrases.some(phrase => answer.includes(phrase));
        }

        // è§£ædifyè¿”å›çš„è®¡åˆ’æ•°æ® - é’ˆå¯¹å®é™…æ ¼å¼ä¼˜åŒ–
        function parsePlanData(rawContent, userQuery) {
            console.log('å¼€å§‹è§£ædifyå†…å®¹ï¼Œé•¿åº¦:', rawContent.length);
            
            // åŸºæœ¬è®¡åˆ’ä¿¡æ¯
            const plan = {
                title: 'èŒåœºæˆé•¿è®¡åˆ’',
                description: 'åŸºäºä¸“ä¸šä¹¦ç±å’Œæ’­å®¢å†…å®¹å®šåˆ¶çš„èŒåœºæˆé•¿æ–¹æ¡ˆ',
                duration: '7å¤©è®¡åˆ’',
                days: []
            };
            
            try {
                // è§£æè®¡åˆ’æ ‡é¢˜
                const titleMatch = rawContent.match(/è®¡åˆ’åç§°[ï¼š:]\s*ã€Š([^ã€‹]+)ã€‹/);
                if (titleMatch) {
                    plan.title = titleMatch[1];
                }
                
                // è§£æç›®æ ‡æè¿°
                const goalMatch = rawContent.match(/ç›®æ ‡[ï¼š:]\s*([\s\S]*?)(?=é¢„æœŸæ•ˆæœ|â€”â€”â€”â€”â€”â€”â€”â€”â€”)/);
                if (goalMatch) {
                    plan.description = goalMatch[1].trim().replace(/\n/g, ' ');
                }
                
                // æŒ‰åˆ†éš”ç¬¦åˆ‡åˆ†æ¯æ—¥å†…å®¹ï¼ˆä¿®å¤ï¼šdifyå®é™…æ²¡æœ‰ä½¿ç”¨åˆ†éš”ç¬¦ï¼‰
                // ç›´æ¥æŒ‰ã€æ ‡é¢˜ã€‘å­—æ®µæ¥åˆ†å‰²æ¯æ—¥å†…å®¹
                const titlePattern = /ã€æ ‡é¢˜ã€‘/g;
                const titleMatches = [...rawContent.matchAll(titlePattern)];
                console.log('æ‰¾åˆ°', titleMatches.length, 'ä¸ªã€æ ‡é¢˜ã€‘æ ‡è®°');
                
                let dailySections = [];
                if (titleMatches.length > 0) {
                    // ç¬¬ä¸€éƒ¨åˆ†ï¼šå¼€å¤´åˆ°ç¬¬ä¸€ä¸ªã€æ ‡é¢˜ã€‘
                    const firstTitlePos = titleMatches[0].index;
                    dailySections.push(rawContent.substring(0, firstTitlePos));
                    
                    // æ¯æ—¥éƒ¨åˆ†ï¼šä»ä¸€ä¸ªã€æ ‡é¢˜ã€‘åˆ°ä¸‹ä¸€ä¸ªã€æ ‡é¢˜ã€‘
                    for (let i = 0; i < titleMatches.length; i++) {
                        const start = titleMatches[i].index;
                        const end = i + 1 < titleMatches.length ? titleMatches[i + 1].index : rawContent.length;
                        dailySections.push(rawContent.substring(start, end));
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ã€æ ‡é¢˜ã€‘ï¼Œå°è¯•ç”¨å…¶ä»–åˆ†éš”ç¬¦
                    dailySections = rawContent.split(/â€”â€”â€”â€”â€”â€”â€”â€”â€”+/);
                }
                
                console.log('åˆ†å‰²åå…±', dailySections.length, 'ä¸ªéƒ¨åˆ†');
                
                // è·³è¿‡ç¬¬ä¸€éƒ¨åˆ†ï¼ˆè®¡åˆ’ä»‹ç»ï¼‰ï¼Œè§£ææ¯æ—¥å†…å®¹
                for (let i = 1; i < dailySections.length; i++) {
                    const section = dailySections[i].trim();
                    if (section) {
                        const dayData = parseDifySectionContent(section, i);
                        if (dayData) {
                            plan.days.push(dayData);
                        }
                    }
                }
                
                // å¦‚æœæ²¡æœ‰è§£æåˆ°å†…å®¹ï¼Œç”Ÿæˆé»˜è®¤æ•°æ®
                if (plan.days.length === 0) {
                    console.warn('æœªè§£æåˆ°æ¯æ—¥å†…å®¹ï¼Œç”Ÿæˆé»˜è®¤æ•°æ®');
                    plan.days = generateDefaultPlan(userQuery);
                }
                
            } catch (error) {
                console.error('è§£æè®¡åˆ’æ•°æ®å¤±è´¥:', error);
                plan.days = generateDefaultPlan(userQuery);
            }
            
            console.log('è§£æå®Œæˆï¼Œå…±', plan.days.length, 'å¤©å†…å®¹');
            return plan;
        }

        function extractPlanTitle(userQuery) {
            if (userQuery.includes('æ–°äºº') || userQuery.includes('èå…¥')) {
                return 'æ–°äººå¿«é€Ÿèå…¥å›¢é˜Ÿè®¡åˆ’';
            } else if (userQuery.includes('æ±‡æŠ¥') || userQuery.includes('æ²Ÿé€š')) {
                return 'é«˜æ•ˆæ±‡æŠ¥è®­ç»ƒè®¡åˆ’';
            } else if (userQuery.includes('å‹åŠ›') || userQuery.includes('æƒ…ç»ª')) {
                return 'å‹åŠ›ç®¡ç†å®è·µè®¡åˆ’';
            } else if (userQuery.includes('äººè„‰') || userQuery.includes('å…³ç³»')) {
                return 'èŒåœºäººè„‰å»ºè®¾æ–¹æ¡ˆ';
            } else {
                return 'èŒåœºæˆé•¿è®¡åˆ’';
            }
        }

        // è§£æå•ä¸ªç« èŠ‚å†…å®¹ - é’ˆå¯¹difyæ ¼å¼
        function parseDifySectionContent(sectionText, dayIndex) {
            console.log(`è§£æç¬¬${dayIndex}å¤©å†…å®¹ï¼Œé•¿åº¦:`, sectionText.length);
            
            const dayData = {
                day: dayIndex,
                æ ‡é¢˜: '',
                é‡‘å¥: '',
                å¯¼è¯­: '',
                å…³é”®åŸåˆ™: '',
                çœŸå®æ¡ˆä¾‹: '',
                ä¸ºä»€ä¹ˆæœ‰æ•ˆ: '',
                ç›¸å…³æ¨è: '',
                ä»Šæ—¥æŒ‘æˆ˜: '',
                æ˜æ—¥é¢„å‘Š: ''
            };
            
            // ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–ã€å­—æ®µåã€‘å†…å®¹çš„æ ¼å¼
            const fieldPatterns = {
                'æ ‡é¢˜': /ã€æ ‡é¢˜ã€‘\s*(.*?)(?=ã€|$)/s,
                'é‡‘å¥': /ã€é‡‘å¥ã€‘\s*(.*?)(?=ã€|$)/s,
                'å¯¼è¯­': /ã€å¯¼è¯­ã€‘\s*(.*?)(?=ã€|$)/s,
                'å…³é”®åŸåˆ™': /ã€å…³é”®åŸåˆ™ã€‘\s*(.*?)(?=ã€|$)/s,
                'çœŸå®æ¡ˆä¾‹': /ã€çœŸå®æ¡ˆä¾‹ã€‘\s*(.*?)(?=ã€|$)/s,
                'ä¸ºä»€ä¹ˆæœ‰æ•ˆ': /ã€ä¸ºä»€ä¹ˆæœ‰æ•ˆã€‘\s*(.*?)(?=ã€|$)/s,
                'ç›¸å…³æ¨è': /ã€ç›¸å…³æ¨èã€‘\s*(.*?)(?=ã€|$)/s,
                'ä»Šæ—¥æŒ‘æˆ˜': /ã€ä»Šæ—¥æŒ‘æˆ˜ã€‘\s*(.*?)(?=ã€|$)/s,
                'æ˜æ—¥é¢„å‘Š': /ã€æ˜æ—¥é¢„å‘Šã€‘\s*(.*?)(?=ã€|$)/s
            };
            
            // æå–æ¯ä¸ªå­—æ®µ
            for (const [field, pattern] of Object.entries(fieldPatterns)) {
                const match = sectionText.match(pattern);
                if (match && match[1]) {
                    dayData[field] = match[1].trim();
                    console.log(`æå–åˆ°${field}:`, dayData[field].substring(0, 50) + '...');
                }
            }
            
            // å¦‚æœæ²¡æœ‰æå–åˆ°æ ‡é¢˜ï¼Œå°è¯•å…¶ä»–æ ¼å¼
            if (!dayData.æ ‡é¢˜) {
                const dayMatch = sectionText.match(/Day\s*(\d+)[Â·\s]*(.*?)(?=\n|ã€)/);
                if (dayMatch) {
                    dayData.æ ‡é¢˜ = `Day ${dayMatch[1]} Â· ${dayMatch[2].trim()}`;
                }
            }
            
            // éªŒè¯æ˜¯å¦æå–åˆ°äº†æœ‰æ•ˆå†…å®¹
            const hasValidContent = dayData.æ ‡é¢˜ || dayData.é‡‘å¥ || dayData.å¯¼è¯­;
            if (!hasValidContent) {
                console.warn(`ç¬¬${dayIndex}å¤©å†…å®¹è§£æå¤±è´¥`);
                return null;
            }
            
            return dayData;
        }

        function parseDayContent(dayText) {
            return {
                æ ‡é¢˜: extractFieldFromText(dayText, 'æ ‡é¢˜') || 'èŒåœºæŠ€èƒ½æå‡',
                é‡‘å¥: extractFieldFromText(dayText, 'é‡‘å¥') || '"æˆåŠŸæºäºæŒç»­çš„å°è¿›æ­¥"',
                å¯¼è¯­: extractFieldFromText(dayText, 'å¯¼è¯­') || 'ä»Šå¤©æˆ‘ä»¬æ¥å­¦ä¹ ä¸€ä¸ªé‡è¦çš„èŒåœºæŠ€èƒ½',
                å…³é”®åŸåˆ™: extractFieldFromText(dayText, 'å…³é”®åŸåˆ™') || 'ä¿æŒç§¯æä¸»åŠ¨çš„æ€åº¦',
                çœŸå®æ¡ˆä¾‹: extractFieldFromText(dayText, 'çœŸå®æ¡ˆä¾‹') || 'å°å¼ é€šè¿‡è¿ç”¨è¿™ä¸ªæ–¹æ³•æˆåŠŸæå‡äº†å·¥ä½œæ•ˆç‡',
                ä¸ºä»€ä¹ˆæœ‰æ•ˆ: extractFieldFromText(dayText, 'ä¸ºä»€ä¹ˆæœ‰æ•ˆ') || 'è¿™ä¸ªæ–¹æ³•åŸºäºå¿ƒç†å­¦åŸç†ï¼Œèƒ½å¤Ÿæœ‰æ•ˆæ”¹å–„å·¥ä½œè¡¨ç°',
                ç›¸å…³æ¨è: extractFieldFromText(dayText, 'ç›¸å…³æ¨è') || 'æ¨èé˜…è¯»ã€Šé«˜æ•ˆèƒ½äººå£«çš„ä¸ƒä¸ªä¹ æƒ¯ã€‹',
                ä»Šæ—¥æŒ‘æˆ˜: extractFieldFromText(dayText, 'ä»Šæ—¥æŒ‘æˆ˜') || 'ä»Šå¤©å°è¯•ä¸ä¸€ä½åŒäº‹è¿›è¡Œæ·±åº¦äº¤æµ',
                æ˜æ—¥é¢„å‘Š: extractFieldFromText(dayText, 'æ˜æ—¥é¢„å‘Š') || 'æ˜å¤©æˆ‘ä»¬å°†å­¦ä¹ æ›´å¤šå®ç”¨æŠ€å·§'
            };
        }

        function extractFieldFromText(text, fieldName) {
            const patterns = [
                new RegExp(`${fieldName}[ï¼š:](.*?)(?=\\n|$)`, 'i'),
                new RegExp(`\\*\\*${fieldName}\\*\\*[ï¼š:]?(.*?)(?=\\n|$)`, 'i'),
                new RegExp(`##\\s*${fieldName}[ï¼š:]?(.*?)(?=\\n|$)`, 'i')
            ];
            
            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match && match[1]) {
                    return match[1].trim();
                }
            }
            return null;
        }

        function generateDaysFromContent(content) {
            // ç®€å•å®ç°ï¼šå°†å†…å®¹åˆ†æˆ7æ®µï¼Œæ¯æ®µä½œä¸ºä¸€å¤©
            const days = [];
            const lines = content.split('\n').filter(line => line.trim());
            const linesPerDay = Math.ceil(lines.length / 7);
            
            for (let i = 0; i < 7; i++) {
                const dayLines = lines.slice(i * linesPerDay, (i + 1) * linesPerDay);
                const dayContent = dayLines.join('\n');
                
                days.push({
                    day: i + 1,
                    æ ‡é¢˜: `ç¬¬${i + 1}å¤©ï¼šèŒåœºæŠ€èƒ½æå‡`,
                    é‡‘å¥: '"æ¯ä¸€å¤©éƒ½æ˜¯æˆé•¿çš„æœºä¼š"',
                    å¯¼è¯­: `ç¬¬${i + 1}å¤©çš„å­¦ä¹ å†…å®¹ï¼ŒåŠ©ä½ æå‡èŒåœºç«äº‰åŠ›`,
                    å…³é”®åŸåˆ™: 'æŒç»­å­¦ä¹ ï¼Œç§¯æå®è·µ',
                    çœŸå®æ¡ˆä¾‹: dayContent.substring(0, 200) + '...',
                    ä¸ºä»€ä¹ˆæœ‰æ•ˆ: 'åŸºäºç§‘å­¦æ–¹æ³•å’Œå®è·µéªŒè¯',
                    ç›¸å…³æ¨è: 'ç›¸å…³ä¸“ä¸šä¹¦ç±å’Œæ’­å®¢æ¨è',
                    ä»Šæ—¥æŒ‘æˆ˜: `å®Œæˆç¬¬${i + 1}å¤©çš„å®è·µä»»åŠ¡`,
                    æ˜æ—¥é¢„å‘Š: i < 6 ? `æ˜å¤©å­¦ä¹ ç¬¬${i + 2}å¤©å†…å®¹` : 'æ­å–œå®Œæˆ7å¤©è®¡åˆ’ï¼'
                });
            }
            
            return days;
        }

        function generateDefaultPlan(userQuery) {
            const basePlan = [
                {
                    day: 1,
                    æ ‡é¢˜: 'ç¬¬1å¤©ï¼šå»ºç«‹ç¬¬ä¸€å°è±¡',
                    é‡‘å¥: '"ä½ æ°¸è¿œä¸ä¼šæœ‰ç¬¬äºŒæ¬¡æœºä¼šæ¥å»ºç«‹ç¬¬ä¸€å°è±¡"',
                    å¯¼è¯­: 'å­¦ä¼šå¦‚ä½•åœ¨èŒåœºä¸­å»ºç«‹è‰¯å¥½çš„ç¬¬ä¸€å°è±¡ï¼Œä¸ºåç»­å‘å±•å¥ å®šåŸºç¡€',
                    å…³é”®åŸåˆ™: 'ä¸»åŠ¨ã€çœŸè¯šã€ä¸“ä¸š',
                    çœŸå®æ¡ˆä¾‹: 'å°æå…¥èŒç¬¬ä¸€å¤©ä¸»åŠ¨ä»‹ç»è‡ªå·±ï¼Œä¸‰ä¸ªæœˆåæˆä¸ºå›¢é˜Ÿæ ¸å¿ƒæˆå‘˜',
                    ä¸ºä»€ä¹ˆæœ‰æ•ˆ: 'å¿ƒç†å­¦ç ”ç©¶è¡¨æ˜ï¼Œç¬¬ä¸€å°è±¡å½±å“90%çš„åç»­äº¤å¾€',
                    ç›¸å…³æ¨è: 'ã€Šé­…åŠ›ã€‹- æŸ¥ç†å¾·Â·å¥¥åˆ©ç»´äºš',
                    ä»Šæ—¥æŒ‘æˆ˜: 'ä¸»åŠ¨å‘3ä½åŒäº‹ä»‹ç»è‡ªå·±',
                    æ˜æ—¥é¢„å‘Š: 'æ˜å¤©å­¦ä¹ å¦‚ä½•å¿«é€Ÿäº†è§£å›¢é˜Ÿæ–‡åŒ–'
                },
                {
                    day: 2,
                    æ ‡é¢˜: 'ç¬¬2å¤©ï¼šäº†è§£å›¢é˜Ÿæ–‡åŒ–',
                    é‡‘å¥: '"é€‚åº”ç¯å¢ƒæ¯”æ”¹å˜ç¯å¢ƒæ›´é‡è¦"',
                    å¯¼è¯­: 'æ·±å…¥äº†è§£å›¢é˜Ÿçš„å·¥ä½œæ–¹å¼ã€ä»·å€¼è§‚å’Œæ½œè§„åˆ™',
                    å…³é”®åŸåˆ™: 'è§‚å¯Ÿã€å€¾å¬ã€å­¦ä¹ ',
                    çœŸå®æ¡ˆä¾‹: 'å°ç‹é€šè¿‡è§‚å¯Ÿå‘ç°å›¢é˜Ÿæ³¨é‡åä½œï¼Œè°ƒæ•´å·¥ä½œæ–¹å¼åå¿«é€Ÿèå…¥',
                    ä¸ºä»€ä¹ˆæœ‰æ•ˆ: 'æ–‡åŒ–é€‚åº”æ˜¯å›¢é˜Ÿèå…¥çš„å…³é”®å› ç´ ',
                    ç›¸å…³æ¨è: 'ã€Šå›¢é˜Ÿåä½œçš„è‰ºæœ¯ã€‹æ’­å®¢',
                    ä»Šæ—¥æŒ‘æˆ˜: 'è§‚å¯Ÿå¹¶è®°å½•å›¢é˜Ÿçš„3ä¸ªå·¥ä½œä¹ æƒ¯',
                    æ˜æ—¥é¢„å‘Š: 'æ˜å¤©å­¦ä¹ å¦‚ä½•å»ºç«‹å·¥ä½œå…³ç³»'
                }
                // å¯ä»¥ç»§ç»­æ·»åŠ æ›´å¤šå¤©çš„å†…å®¹...
            ];
            
            // æ ¹æ®ç”¨æˆ·æŸ¥è¯¢è°ƒæ•´å†…å®¹
            return basePlan.slice(0, 7); // è¿”å›7å¤©å†…å®¹
        }

        // æ¸²æŸ“è®¡åˆ’åˆ—è¡¨
        function renderPlanList(plan) {
            // æ›´æ–°æ ‡é¢˜å’Œæè¿°
            document.getElementById('planTitle').textContent = plan.title;
            document.getElementById('planDescription').textContent = plan.description;
            document.getElementById('planDuration').textContent = plan.duration;
            
            // æ¸²æŸ“æ¯æ—¥å†…å®¹åˆ—è¡¨
            const listContainer = document.getElementById('dailyContentList');
            listContainer.innerHTML = '';
            
            plan.days.forEach((day, index) => {
                const dayItem = document.createElement('div');
                dayItem.className = 'bg-gray-50 rounded-lg p-4 hover:bg-gray-100 cursor-pointer transition-colors';
                dayItem.onclick = () => showContentDetailView(index);
                
                dayItem.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="text-sm font-medium text-gray-900">ç¬¬${day.day || index + 1}å¤©</div>
                        <div class="text-xs text-gray-500">5åˆ†é’Ÿé˜…è¯»</div>
                    </div>
                    <div class="text-base font-bold text-gray-900 mb-1">${day.æ ‡é¢˜}</div>
                    <div class="text-sm text-gray-600 mb-2">${day.é‡‘å¥}</div>
                    <div class="text-xs text-gray-500 line-clamp-2">${day.å¯¼è¯­}</div>
                `;
                
                listContainer.appendChild(dayItem);
            });
        }

        // æ¸²æŸ“å†…å®¹è¯¦æƒ…é¡µ
        function renderContentDetail(dayIndex) {
            const day = currentPlan.days[dayIndex];
            if (!day) return;
            
            const container = document.getElementById('contentDetailView');
            container.innerHTML = `
                <div class="max-w-md mx-auto bg-white font-geneva">
                    <!-- å¤´å›¾åŒºåŸŸ - æ‚å¿—å°é¢é£æ ¼ -->
                    <div class="bg-black text-white p-8 relative">
                        <button onclick="showSubscriptionView()" class="absolute top-4 left-4 text-white hover:text-gray-300">
                            â† è¿”å›
                        </button>
                        <div class="absolute top-4 right-4 text-xs text-gray-400">DAY ${day.day || dayIndex + 1}</div>
                        <div class="text-xs text-gray-300 mb-2 tracking-widest">WORKPLACE ESSENTIALS</div>
                        <div class="text-2xl font-bold mb-3 leading-tight">${day.æ ‡é¢˜}</div>
                        <div class="w-12 h-0.5 bg-white mb-4"></div>
                        <div class="text-sm text-gray-200 italic">"${day.é‡‘å¥}"</div>
                    </div>

                    <div class="p-6 space-y-6">
                        <!-- å¼€ç¯‡æ–‡å­— -->
                        <div class="text-gray-800 leading-relaxed">
                            <p class="text-sm mb-3">${day.å¯¼è¯­}</p>
                        </div>

                        <!-- æ ¸å¿ƒæ–¹æ³• -->
                        <div class="border border-gray-200 p-5 bg-gray-50">
                            <div class="text-center mb-4">
                                <div class="text-lg font-bold text-gray-900 mb-1">æ ¸å¿ƒåŸåˆ™</div>
                                <div class="text-xs text-gray-600 tracking-wide">TODAY'S KEY PRINCIPLE</div>
                            </div>
                            <div class="text-center">
                                <div class="text-sm text-gray-700">${day.å…³é”®åŸåˆ™}</div>
                            </div>
                        </div>

                        <!-- æ¡ˆä¾‹æ•…äº‹ -->
                        <div class="text-gray-800 leading-relaxed">
                            <div class="text-sm font-bold text-gray-900 mb-2">çœŸå®æ¡ˆä¾‹</div>
                            <p class="text-sm mb-3">${day.çœŸå®æ¡ˆä¾‹}</p>
                        </div>

                        <!-- ç†è®ºæ”¯æ’‘ -->
                        <div class="border-l-2 border-gray-300 pl-4">
                            <div class="text-xs text-gray-500 mb-1">WHY IT WORKS</div>
                            <div class="text-sm text-gray-700">${day.ä¸ºä»€ä¹ˆæœ‰æ•ˆ}</div>
                        </div>

                        <!-- ç›¸å…³æ¨è -->
                        <div class="bg-black text-white p-4">
                            <div class="flex justify-between items-start mb-2">
                                <div class="text-xs text-gray-400 tracking-widest">RECOMMENDED READING</div>
                                <div class="text-xs text-gray-400">æ¨è</div>
                            </div>
                            <div class="text-sm font-bold mb-1">å»¶ä¼¸å­¦ä¹ </div>
                            <div class="text-xs text-gray-300 mb-3">${day.ç›¸å…³æ¨è}</div>
                        </div>

                        <!-- è¡ŒåŠ¨å·å¬ -->
                        <div class="text-center py-4">
                            <div class="text-lg font-bold text-gray-900 mb-2">ä»Šæ—¥æŒ‘æˆ˜</div>
                            <div class="text-sm text-gray-700 mb-3">${day.ä»Šæ—¥æŒ‘æˆ˜}</div>
                            <button onclick="completeDayChallenge(${dayIndex})" class="bg-black text-white px-6 py-2 text-sm hover:bg-gray-800 transition-colors">
                                å®Œæˆä»Šæ—¥æŒ‘æˆ˜
                            </button>
                        </div>

                        <!-- é¢„å‘Š -->
                        <div class="text-center border-t border-gray-200 pt-4">
                            <div class="text-xs text-gray-500 tracking-widest mb-1">TOMORROW</div>
                            <div class="text-sm text-gray-700">${day.æ˜æ—¥é¢„å‘Š}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // å®Œæˆæ¯æ—¥æŒ‘æˆ˜
        function completeDayChallenge(dayIndex) {
            alert('å¤ªæ£’äº†ï¼ä½ å®Œæˆäº†ä»Šå¤©çš„æŒ‘æˆ˜ã€‚ç»§ç»­ä¿æŒè¿™ç§ç§¯æçš„æ€åº¦ï¼');
            // è¿™é‡Œå¯ä»¥æ·»åŠ è¿›åº¦è·Ÿè¸ªé€»è¾‘
        }

        // æµ‹è¯•è§£æåŠŸèƒ½ï¼ˆä»…ç”¨äºå¼€å‘è°ƒè¯•ï¼‰
        function testParsing() {
            const sampleContent = `èŒåœºäººè„‰ã€ŒåŠ é€Ÿé“¾æ¥ã€7 å¤©æˆé•¿è®¡åˆ’
ç›®æ ‡ï¼šå¸®åŠ©"äº§å“ç»ç† / 1 ä¸ªæœˆ"åœ¨ 1 å‘¨å†…å»ºç«‹ä¸€å¥—å¯å¤åˆ¶çš„äººè„‰æ‹“å±•æ–¹æ³•ï¼Œå®Œæˆè‡³å°‘ 3 ä½å…³é”®è”ç³»äººæ·±åº¦é“¾æ¥ã€10 ä½å¼±å…³ç³»æ¿€æ´»ï¼Œå¹¶å½¢æˆé•¿æœŸç»´æŠ¤æœºåˆ¶ã€‚
ç»„æˆï¼š

ç›®æ ‡è®¾å®šä¸èµ„æºç›˜ç‚¹
å½¢è±¡æ‰“é€ ä¸ä»·å€¼åŒ…è£…
ä¸»åŠ¨å‡ºå‡»ä¸æ·±åº¦äº¤æµ
å‘¨æœ«å¤ç›˜ä¸æƒ…ç»ªç–—æ„ˆ
é¢„æœŸæ•ˆæœï¼šæŒæ¡ 5+ äººè„‰å·¥å…·ï¼Œå®Œæˆå¯è§†åŒ–ç½‘ç»œå›¾ã€ä¸“å± follow-up è¯æœ¯ä¸ 90 å¤©ç»´æŠ¤èŠ‚å¥ï¼Œå‡å°‘ç¤¾äº¤ç„¦è™‘ï¼Œæå‡è·¨éƒ¨é—¨ååŒæ•ˆç‡ã€‚
ã€æ ‡é¢˜ã€‘Day 1 Â· 60 åˆ†é’Ÿäººè„‰åœ°å›¾å¯åŠ¨æ³•
ã€é‡‘å¥ã€‘"å…ˆæå¥½åœ°å›¾ï¼Œå†ä¸Šè·¯ï¼Œä½ æ‰çŸ¥é“æ¯ä¸€æ­¥èµ°ç»™è°çœ‹ã€‚"
ã€å¯¼è¯­ã€‘å‘¨äºŒçš„èŠ‚å¥åˆšåˆšæ‹‰å¼€ï¼Œä½ æˆ–è®¸è¿˜åœ¨é€‚åº”æ–°ç¯å¢ƒã€‚åˆ«æ‹…å¿ƒï¼Œå‡ ä¹æ‰€æœ‰åˆšå…¥èŒçš„äº§å“ç»ç†éƒ½å›°æƒ‘ï¼šæˆ‘è¯¥å…ˆæ‰¾è°èŠï¼Ÿä»Šå¤©ï¼Œæˆ‘ä»¬ç”¨ 60 åˆ†é’Ÿç”»å‡ºä½ çš„ç¬¬ä¸€å¼ èŒåœºäººè„‰åœ°å›¾ï¼Œè®©ç›®æ ‡æ¸…æ™°å¯è§ã€‚
ã€å…³é”®åŸåˆ™ã€‘

ä¸šåŠ¡å…³è”åº¦ä¼˜å…ˆï¼šåˆ—å‡ºéœ€æ±‚æœ€å¤šçš„ 3 æ¡æ ¸å¿ƒä¸šåŠ¡é“¾ï¼ˆäº§å“ã€ç ”å‘ã€è¿è¥ï¼‰ã€‚
è§’è‰²åˆ†å±‚ï¼šå…³é”®å†³ç­–äººã€åˆä½œæ‰§è¡Œè€…ã€æ½œåœ¨å¯¼å¸ˆã€åŒè¾ˆä¼™ä¼´ã€‚
ä¸‰åº¦äººè„‰æ€ç»´ï¼ˆGranovetter å¼±è¿æ¥ç†è®ºï¼‰ï¼šå¼±å…³ç³»å¾€å¾€å¸¦æ¥çªç ´æ€§èµ„æºï¼Œä¸æ­¢å…³æ³¨ç›´å±åŒäº‹ã€‚
å¯è§†åŒ–å·¥å…·ï¼šç”¨ Miro/ç™½æ¿æ‰‹ç»˜ï¼Œæ¯ä¸ªåå­—åæ ‡æ³¨"æˆ‘èƒ½ä¸º TA æä¾›ä»€ä¹ˆ"ã€‚
ç›®æ ‡æ•°å­—ï¼š15 ä¸ªåå­—å³å¯ï¼Œä¸è¦è´ªå¤šã€‚
ã€çœŸå®æ¡ˆä¾‹ã€‘Reid Hoffmanåœ¨åˆ›ä¸š LinkedIn å‰ï¼Œç”¨ä¾¿åˆ©è´´å°†è‡ªå·±éœ€è¦çš„æŠ•èµ„äººã€æ‹›è˜é¡¾é—®ã€æŠ€æœ¯é¡¾é—®è´´æ»¡å¢™ï¼Œå¹¶å†™ä¸‹"æˆ‘èƒ½å…ˆå¸®åˆ°ä»–ä»¬ä»€ä¹ˆ"ï¼Œ4 å‘¨å†…çº¦åˆ° 70% è§é¢ã€‚åæ¥ä»–ç§°è¿™å¼ å¢™ä¸º"æœºä¼šå‘ç”Ÿå™¨"ã€‚
ã€ä¸ºä»€ä¹ˆæœ‰æ•ˆã€‘ç¤¾ä¼šèµ„æœ¬ç†è®ºæŒ‡å‡ºï¼Œèµ„æºæµåŠ¨ä¾èµ–ç½‘ç»œç»“æ„ï¼›å…ˆå®šä½èŠ‚ç‚¹å†å¸ƒå±€ï¼Œèƒ½é™ä½ 40% çš„æœç´¢æˆæœ¬ï¼ˆBurt, 1992ï¼‰ã€‚Miro çš„è§†è§‰åŒ–è¾“å…¥è§¦å‘"ç©ºé—´è®°å¿†æ•ˆåº”"ï¼ˆè®¤çŸ¥å¿ƒç†å­¦ï¼‰ï¼Œæå‡ 30% å¬å›ç‡ã€‚
ã€ç›¸å…³æ¨èã€‘ã€Šå…³é”®è·¯å¾„ï¼šäº§å“ç»ç†çš„äººè„‰ç­–ç•¥ã€‹â€”â€”"åœ°å›¾è®©ä½ ä¸å†æ— å¤´è‹è‡ã€‚"
ã€ä»Šæ—¥æŒ‘æˆ˜ã€‘ä»Šå¤©ä¸‹ç­å‰å®Œæˆ 15 äººäººè„‰åœ°å›¾ï¼Œå¹¶ç»™ 3 ä½æ ‡æ˜Ÿä¸º"é¦–è¦è”ç³»"ã€‚
ã€æ˜æ—¥é¢„å‘Šã€‘æ˜å¤©æ•™ä½ æ‰“é€  30 ç§’ç”µæ¢¯å™äº‹ï¼Œè®©æ¯ä¸€æ¬¡è‡ªæˆ‘ä»‹ç»éƒ½ä»·å€¼çˆ†è¡¨ã€‚
ã€æ ‡é¢˜ã€‘Day 2 Â· 30 ç§’ç”µæ¢¯å™äº‹ï¼šè®©ä»‹ç»è‡ªå¸¦é’©å­
ã€é‡‘å¥ã€‘"æœ€çŸ­çš„ä»‹ç»ï¼Œè£…ä¸‹æœ€å¤§çš„ä»·å€¼ã€‚"
ã€å¯¼è¯­ã€‘å‘¨ä¸‰äººæµæœ€å¯†é›†ï¼ŒèŒ¶æ°´é—´ã€ç”µæ¢¯é‡Œéƒ½æ˜¯æœºä¼šã€‚ä½ åªéœ€è¦ä¸€æ®µ 30 ç§’çš„è¯æœ¯ï¼Œè®©å¯¹æ–¹è®°ä½ä½ "è§£å†³é—®é¢˜çš„äººè®¾"ã€‚
ã€å…³é”®åŸåˆ™ã€‘

FAB æ¨¡æ¿ï¼šFeatureï¼ˆèº«ä»½ï¼‰â€“Advantageï¼ˆä¼˜åŠ¿ï¼‰â€“Benefitï¼ˆå¯¹ä»–äººçš„å¥½å¤„ï¼‰ã€‚
å…³é”®è¯â‰¤3 ä¸ªï¼›é¿å…è¡Œè¯ï¼Œçªå‡º"å¯è¢«è½¬è¿°"ã€‚
åŠ å…¥å°é’©å­ï¼šæ•°å­—æˆ˜ç»©æˆ–ç‹¬ç‰¹çˆ±å¥½ï¼Œæ–¹ä¾¿ç»§ç»­å¯¹è¯ã€‚
ç»ƒä¹  10 éï¼Œç¡®ä¿è¯­é€Ÿâ‰ˆ150 wpmã€‚
ã€çœŸå®æ¡ˆä¾‹ã€‘å­—èŠ‚è·³åŠ¨äº§å“ç»ç†æ™“å®æ¯æ¬¡è·¨éƒ¨é—¨è¯„å®¡å‰éƒ½ä¼šç”¨ "Hiï¼Œæˆ‘æ˜¯æ™“å®ï¼Œå…³æ³¨å¢é•¿æ¼æ–—ï¼Œæœ€è¿‘æŠŠæ–°æ‰‹ç•™å­˜æé«˜äº† 18%ï¼Œå¯éšæ—¶å¸®å¿™åšåŸ‹ç‚¹è¯Šæ–­" å¼€åœºï¼Œä¸€å¹´å†…æˆä¸º 4 ä¸ªå›¢é˜Ÿçš„"é»˜è®¤é¡¾é—®"ã€‚
ã€ä¸ºä»€ä¹ˆæœ‰æ•ˆã€‘æ ¹æ® Cialdini "å°åˆ»æ•ˆåº”"ï¼Œé¦–è½®ä¿¡æ¯è‹¥åŒæ—¶æ»¡è¶³æ¸…æ™°ã€åˆ©ä»–ä¸å¯å¤è¿°ï¼Œè®°å¿†ç‚¹å¯æå‡ 2 å€ã€‚FAB æ¨¡å‹æºè‡ªå®æ´é”€å”®è®­ç»ƒï¼Œè¢«éªŒè¯å¯åœ¨ 7 ç§’å†…ä¼ é€’ä»·å€¼ã€‚
ã€ç›¸å…³æ¨èã€‘å–œé©¬æ‹‰é›…ã€Šç”µæ¢¯æ¼”è®²é­”é¬¼è®­ç»ƒè¥ã€‹â€”â€”"ç»™å¯¹æ–¹ä¸€å¥è¯ï¼Œå°±èƒ½æƒ³èµ·ä½ ã€‚"
ã€ä»Šæ—¥æŒ‘æˆ˜ã€‘å½•éŸ³ 3 ç‰ˆç”µæ¢¯å™äº‹ï¼Œå‘ç»™å¥½å‹æ‰“åˆ†ï¼Œå¾—åˆ†â‰¥8/10 æ–¹å¯æ”¶å½•ã€‚
ã€æ˜æ—¥é¢„å‘Šã€‘æ˜å¤©æˆ‘ä»¬èµ°å‡ºèˆ’é€‚åŒºï¼Œå‘é€ç¬¬ä¸€æ³¢ä»·å€¼å‹é—®å€™ã€‚`;
            
            console.log('å¼€å§‹æµ‹è¯•è§£æåŠŸèƒ½...');
            const testPlan = parsePlanData(sampleContent, 'æµ‹è¯•');
            console.log('è§£æç»“æœ:', testPlan);
            
            // ç›´æ¥æ¸²æŸ“åˆ°ç•Œé¢è¿›è¡Œæµ‹è¯•
            currentPlan = testPlan;
            renderPlanList(currentPlan);
            showSubscriptionView();
        }

        // åœ¨é¡µé¢åŠ è½½å®Œæˆåæ·»åŠ è°ƒè¯•æŒ‰é’®ï¼ˆå¯é€‰ï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            // æ·»åŠ è°ƒè¯•æŒ‰é’®åˆ°é¡µé¢ï¼ˆå¯é€‰ï¼Œç”¨äºå¼€å‘è°ƒè¯•ï¼‰
            if (window.location.hostname === 'localhost' || window.location.hostname.includes('local')) {
                const debugBtn = document.createElement('button');
                debugBtn.textContent = 'Debug';
                debugBtn.style.cssText = 'position:fixed;top:10px;right:10px;z-index:9999;background:red;color:white;padding:5px;';
                debugBtn.onclick = debugInfo;
                document.body.appendChild(debugBtn);
                
                const testBtn = document.createElement('button');
                testBtn.textContent = 'Test Parse';
                testBtn.style.cssText = 'position:fixed;top:10px;right:80px;z-index:9999;background:blue;color:white;padding:5px;';
                testBtn.onclick = testParsing;
                document.body.appendChild(testBtn);
                
                // æ·»åŠ ä¸€ä¸ªè¾“å…¥æµ‹è¯•æŒ‰é’®
                const inputTestBtn = document.createElement('button');
                inputTestBtn.textContent = 'Input Test';
                inputTestBtn.style.cssText = 'position:fixed;top:40px;right:80px;z-index:9999;background:green;color:white;padding:5px;font-size:10px;';
                inputTestBtn.onclick = () => {
                    const content = prompt('è¯·è¾“å…¥difyè¿”å›çš„å†…å®¹è¿›è¡Œæµ‹è¯•:');
                    if (content) {
                        console.log('å¼€å§‹æµ‹è¯•ç”¨æˆ·è¾“å…¥çš„å†…å®¹...');
                        handleConversationResponse(content, 'æµ‹è¯•ç”¨æˆ·æ¶ˆæ¯');
                    }
                };
                document.body.appendChild(inputTestBtn);
                
                // æ·»åŠ å¼ºåˆ¶è§£ææŒ‰é’®
                const forceParseBtn = document.createElement('button');
                forceParseBtn.textContent = 'Force Parse';
                forceParseBtn.style.cssText = 'position:fixed;top:70px;right:80px;z-index:9999;background:orange;color:white;padding:5px;font-size:10px;';
                forceParseBtn.onclick = () => {
                    const content = prompt('è¾“å…¥å†…å®¹å¼ºåˆ¶è§£æï¼ˆå¿½ç•¥æ£€æµ‹ï¼‰:');
                    if (content) {
                        console.log('å¼ºåˆ¶è§£æå†…å®¹...');
                        // å¼ºåˆ¶è§£æï¼Œè·³è¿‡æ£€æµ‹
                        conversationPhase = 'completed';
                        planGenerationInProgress = false;
                        currentPlan = parsePlanData(content, 'å¼ºåˆ¶è§£ææµ‹è¯•');
                        console.log('å¼ºåˆ¶è§£æç»“æœ:', currentPlan);
                        renderPlanList(currentPlan);
                        showSubscriptionView();
                    }
                };
                document.body.appendChild(forceParseBtn);
            }
        });
    </script>
</body>
</html>
